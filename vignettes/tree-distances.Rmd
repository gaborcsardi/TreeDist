---
title: "Measuring tree distance"
author: "Martin R. Smith"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: ../inst/REFERENCES.bib
csl: ../inst/apa-old-doi-prefix.csl
vignette: >
  %\VignetteIndexEntry{Measuring tree similarity}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{R init}
abbrevs <- c(
  rf  = 'Robinson-Foulds',
  vai = 'Var. Arb Info',
  spr = 'SPR',
  vci = 'Var. Clustering Info', 
  nts = 'Nye et al.',
  qd  = 'Quartet',
  vpi = 'Var. Partition Info',
  path = 'Path',
  msd = 'Matching Splits'
)
cbPalette8 <- Ternary::cbPalette8
methodCol <- c(
'#4e78a8',
'#f28e2c',
'#e15659',
'#75b7b2',
'#58a14e',
'#edc949',
'#af7aa1',
'#fd9da7',
'#9d745f',
'#bab0ac')[1:9] # https://www.tableau.com/about/blog/2016/7/colors-upgrade-tableau-10-56782
#TreeSearch::brewer[[9]] #cbPalette8[c(1:5, 6, 7, 8, 8)]
methodPch <- c(3, 3, 6, 3, 3, 4, 4, 4, 6)
names(methodCol) <- names(methodPch) <- names(abbrevs)
methodLCH <- colorspace::coords(as(colorspace::hex2RGB(methodCol), 'polarLUV'))
```

## Expected tree distance of random tree pair

This figure shows how the normalized tree distance varies with the number of 
tips in the trees being compared.

Metrics marked with &#9661; are normalized based on the maximum possible value;
information-based metrics, marked +, are normalized against the total 
information content of each pair of trees; metrics marked &times; do not have a 
readily calculated maximum value and are thus normalized against the maximum 
observed distance for each number of tips.

```{R Tree-distance-averages, echo=FALSE, message=FALSE, cache=TRUE, fig.asp=1, fig.width=6, out.width='90%', fig.align='center'}

data('randomTreeDistances', package='TreeDistData')

AddLine <- function (method, Normalize = I) {
  dat <- Normalize(randomTreeDistances[method, , ])
  col <- methodCol[method]
  pch <- methodPch[method]
  nLeaves <- colnames(dat)
  points(nLeaves, dat['mean', ], pch=pch, col=col)
  lines(nLeaves, dat['mean', ] + dat['sd', ], lty=3, col=col)
  lines(nLeaves, dat['mean', ] - dat['sd', ], lty=3, col=col)
}


hi2lo <- c('vai', 'vci', 'nts', 'qd', 'vpi', 'msd', 'path', 'spr', 'rf')

plot(as.integer(dimnames(randomTreeDistances)[[3]]), 
     randomTreeDistances['vai', 'mean', ],
     ylim=c(0.25, 1), type='n',
     xlab = "Number of tips", ylab = "Normalized tree distance")
for (i in 1:5) AddLine(hi2lo[i])

nLeaves <- as.integer(dimnames(randomTreeDistances)[[3]])
# Crude normalization against diameter
AddLine('msd', function (x) x / rep(max(randomTreeDistances['msd', , 'max']), each=4))
AddLine('path', function (x) x / rep((nLeaves * 8), each=4))
AddLine('spr')
AddLine('rf')


legend('bottomright', bty='n', pch=methodPch, 
       legend=abbrevs, 
       col=methodCol)
```


## Distribution of tree distances

```{r load-data-dists, include=FALSE}
data('distanceDistribution25', package='TreeDistData')
distanceDistribution25['rf', ] <- distanceDistribution25['rf', ] / 2L
```

The histograms below depict the distribution of tree distances for
`r dim(distanceDistribution25)[2]`
pairs of trees drawn at random from the uniform distribution.

```{R Tree-distance-distributions, echo=FALSE, message=FALSE, cache=TRUE, fig.asp=1, fig.width=6, out.width='90%', fig.align='center'}
par(mfrow=c(3, 3), mar=rep(1.9, 4), cex=0.8, oma=c(0, 0, 2, 0))
manyBreaks <- seq(0, 1, length.out=40)

PlotHist <- function (method, breaks) {
  hist(distanceDistribution25[method, ], xlab=NULL, main=NULL, breaks=breaks, 
       cex=0.8, border = methodCol[method])
  legend('topleft', bty='n', c('', '', abbrevs[method]), cex=0.8)
}

PlotHist('vai', manyBreaks)
mtext('Distance between pectinate tree (above) and random bifurcating trees', outer=TRUE, cex=0.8)

PlotHist('vci', manyBreaks)
PlotHist('nts', manyBreaks)
PlotHist('qd',  manyBreaks)
PlotHist('vpi', manyBreaks)
PlotHist('msd', 40L)
PlotHist('path', 40L)
PlotHist('spr', 0:max(distanceDistribution25['spr', ]))
PlotHist('rf',  0:22)

```

# Distances between all 7-tip trees 

Inspired by @Kendall2016...

```{r 7-tip-funcs, include=FALSE} 
Palette <- function (n) colorspace::sequential_hcl(n, palette='BluYl')
MethodPalette <- function (method, n) colorspace::sequential_hcl(n,
                             h = methodLCH[method, 'H'], 
                             c = methodLCH[method, 'C'],
                             l = c(max(40, methodLCH[method, 'L']) - 30, 95),
                             power = 0.9)

data('sevenTipDistances', package='TreeDistData')
td7 <- sevenTipDistances
td7$rf <- td7$rf / 2L
treeShapes <- td7$shapes
shapes <- treeShapes[order(treeShapes)]
treeCols <- Ternary::cbPalette8[2:7]
names(treeCols) <- unique(shapes)


Hist <- function (method, breaks=32L) {
  h <- hist(td7[[method]], breaks=breaks, plot=FALSE)
  plot(h, col=MethodPalette(method, length(h$breaks)), main=abbrevs[method])
}

PlotMDS <- function(method) {
  space <- MASS::isoMDS(td7[[method]], k=2, trace=FALSE)
  pts <- space$points
  plot(pts, pch=19, col=paste0(treeCols[as.character(shapes)], '88'),
       xlab='', ylab='')
  z <- MASS::kde2d(pts[, 1], pts[, 2])
  contour(z, add=TRUE, col='#00000088')
  legend('bottomleft', legend=paste0('stress = ', signif(space$stress, 3)), bty='n')
  legend('topleft', legend=abbrevs[method], bty='n', text.font=2)
}

TableImage <- function (method) {
  x <- rep(seq_len(945), each=945L)
  y <- rep(seq_len(945), 945L)
  plot(-100, -100, type='n', ylim=c(0, 965), xlim=c(965, 0), 
       axes=FALSE, xlab='', ylab='')
  shapeSizes <- table(shapes)
  shapeSum <- cumsum(shapeSizes)
  shapeStarts <-  shapeSum - shapeSizes
  rect(shapeStarts, 950, shapeSum, 975, col=Ternary::cbPalette8[2:7], border=NA)
  rect(950, shapeStarts, 975, shapeSum, col=Ternary::cbPalette8[2:7], border=NA)

  rect(x - 1L, y - 1L, x, y, border=NA,
       col=MethodPalette(method, 100)[cut(td7[[method]], 100, labels=FALSE)])
}
```

```{r 7-tip-trees-histograms, echo=FALSE, message=FALSE, cache=TRUE, fig.asp=1, fig.width=6, out.width='90%', fig.align='center'}
par(mfrow=c(3, 3), mar=c(2.4, 0.8, 2.4, 0.8))

Hist('vai')
Hist('vci')
Hist('nts')
Hist('qd')
Hist('vpi')
Hist('msd', breaks=10)
Hist('path')
Hist('spr', breaks=3)
Hist('rf', breaks=4)
```

The coloured bars at the edges of the matrix plots correspond to the shape of 
the trees being compared, as depicted here.
```{r 7-tip-tree-shapes, echo=FALSE, message=FALSE, cache=TRUE, fig.asp=1/6, fig.width=6, out.width='90%', fig.align='center'}
par(mfrow=c(1, 6), mar=c(0, 1, 0, 1) * 0.2)

treeShapes <- c('(a, (b, (c, (d, (e, (f, g))))));',
                '(a, (b, (c, ((d, e), (f, g)))));',
                '(a, (b, ((c, d), (e, (f, g)))));',
                '(a, ((b, c), (d, (e, (f, g)))));',
                '(a, ((b, c), ((d, e), (f, g))));',
                '(a, ((b, (c, d)), (e, (f, g))));')
lapply(seq_along(treeShapes), function (i) {
  tree <- ape::read.tree(text = treeShapes[i])
  tree$edge.length <- rep(1, 12)
  plot(tree,
       edge.col=Ternary::cbPalette8[8L - i], 
       edge.width = 2L,
       show.tip.label = FALSE)
}) -> XX
```

```{r 7-tip-trees-2, echo=FALSE, message=FALSE, cache=TRUE, fig.asp=1, fig.width=6, out.width='90%', fig.align='center'}
par(mfrow=c(3, 3), mar=rep(0.8, 4))
TableImage('vai')
TableImage('vci')
TableImage('nts')
TableImage('qd')
TableImage('vpi')
TableImage('msd')
TableImage('path')
TableImage('spr')
TableImage('rf')
```

```{r 7-tip-trees-3, echo=FALSE, message=FALSE, cache=TRUE, fig.asp=1, fig.width=6, out.width='90%', fig.align='center'}
par(mfrow=c(3, 3), mar=rep(0.8, 4))

PlotMDS('vai')
PlotMDS('vci')
PlotMDS('nts')
PlotMDS('qd')
PlotMDS('vpi')
PlotMDS('msd')
PlotMDS('path')
PlotMDS('spr')
PlotMDS('rf')
```

## References
